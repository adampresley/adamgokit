package main

import (
	"context"
	"embed"
	"log/slog"
	"net/http"
	{{- if .DBName}}
	"os"{{end}}{{- if .AddIdentityManagement}}
	"time"
	"encoding/gob"{{end}}

	"github.com/adampresley/adamgokit/httphelpers"
	"github.com/adampresley/adamgokit/mux"
	"github.com/adampresley/adamgokit/rendering"
	"{{.GithubRepo}}/cmd/{{.AppName}}/internal/configuration"
	"{{.GithubRepo}}/cmd/{{.AppName}}/internal/home"{{- if .DBName}}
	"github.com/glebarez/sqlite"
	"gorm.io/gorm"{{- if .AddIdentityManagement}}
	"{{.GithubRepo}}/cmd/{{.AppName}}/internal/identity"
	"github.com/adampresley/adamgokit/sessions"
	"github.com/adampresley/adamgokit/auth2"
	"{{.GithubRepo}}/pkg/identities"
	"{{.GithubRepo}}/pkg/database"{{end}}
	{{end}}
)

var (
	Version string = "development"
	appName string = "{{.AppName}}"

	//go:embed app
	appFS embed.FS

	/* Services */{{- if .DBName}}
	db       *gorm.DB{{end}}
	renderer rendering.TemplateRenderer{{if .AddIdentityManagement}}
	sessionService sessions.Session[*identities.User]
	userService    identities.UserServicer{{end}}

	/* Controllers */
	homeController     home.HomeHandlers{{if .AddIdentityManagement}}
	identityController identity.IdentityHandlers{{end}}
)

func main() { 
	var (
		err error
	)

	config := configuration.LoadConfig()
	shutdownCtx, stopApp := context.WithCancel(context.Background())
	setupLogger(&config, Version)

	slog.Info("configuration loaded",
		"app", appName,
		"version", Version,
		"loglevel", config.LogLevel,
		"host", config.Host,
	)

	slog.Debug("setting up..."){{- if .DBName}}

	/*
	 * Setup database
	 */
	if err = os.MkdirAll("./data", 0755); err != nil {
		panic(err)
	}

	if db, err = gorm.Open(sqlite.Open(config.DSN)); err != nil {
		panic(err)
	}

	if err = migrateDatabase(db); err != nil {
		panic(err)
	}{{if .AddIdentityManagement}}

	if Version == "development" {
		if err = identity.BootstrapAdminUser(db); err != nil {
			panic(err)
		}
	}{{end}}{{end}}{{if .AddIdentityManagement}}

	gob.Register(&identities.UserSession{})

	cookieStore := sessions.NewCookieStore(
		config.CookieSecret,
		sessions.WithMaxAge(time.Hour*24),
	)

	auth := auth2.New(
		auth2.UserNameAndPassword[*identities.UserSession](
			cookieStore,
			"{{.AppName}}",
			"user",
			auth2.WithContextKey("session"),
			auth2.WithExcludedPaths([]string{
				"/error",
				"/login",
				"/account/sign-up",
				"/account/sign-up-success",
				"/account/verify",
			}),
			auth2.WithRedirectURL("/login"),
			auth2.WithErrorFunc(func(w http.ResponseWriter, r *http.Request, err error) {
				http.Redirect(w, r, "/error?message="+err.Error(), http.StatusSeeOther)
			}),
		),
	)

	{{end}}

	/*
	 * Setup services
	 */
	if renderer, err = rendering.NewGoTemplateRenderer(appFS); err != nil {
		panic(err)
	}{{if .AddIdentityManagement}}

	userService = identities.NewUserService(identities.UserServiceConfig{
		DbServiceBaseConfig: database.DbServiceBaseConfig{
			QueryTimeout: 5 * time.Second,
			DB:           db,
			PageSize:     config.PageSize,
		},
	}){{end}}

	/*
	 * Setup controllers
	 */
	homeController = home.NewHomeController(home.HomeControllerConfig{
		Config:   &config,
		Renderer: renderer,
	}){{- if .AddIdentityManagement}}

	identityController = identity.NewIdentityController(identity.IdentityControllerConfig{
		Auth:        auth,
		Config:      &config,
		Renderer:    renderer,
		UserService: userService,
	}){{end}}

	/*
	 * Setup router and http server
	 */
	slog.Debug("setting up routes...")

	routes := []mux.Route{
		{Path: "GET /heartbeat", HandlerFunc: heartbeat},
		{Path: "GET /", HandlerFunc: homeController.HomePage},
		{Path: "GET /about", HandlerFunc: homeController.AboutPage},{{- if .AddIdentityManagement}}
		{Path: "GET /login", HandlerFunc: identityController.LoginPage},
		{Path: "POST /login", HandlerFunc: identityController.LoginAction},
		{Path: "GET /logout", HandlerFunc: identityController.LogoutAction},{{end}}
	}

	mux := mux2.Setup(
		&config,
		routes,
		shutdownCtx,
		stopApp,

		mux2.WithStaticContent("app", "/static/", appFS),
		mux2.UseGzip(),
		mux2.UseGzipForStaticFiles(),
		mux2.WithDebug(Version == "development"),
	)

	/*
	 * Start the server. Wait for graceful shutdown.
	 */
	slog.Info("server started")
	mux.Start()
	slog.Info("server stopped")
}

func heartbeat(w http.ResponseWriter, r *http.Request) {
	httphelpers.TextOK(w, "OK")
}{{if .DBName}}

func migrateDatabase(db *gorm.DB) error {
	return db.AutoMigrate({{- if.AddIdentityManagement}}
		&identities.User{},{{end}}
	)
}{{end}}
